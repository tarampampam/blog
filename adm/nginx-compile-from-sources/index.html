<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Собираем nginx из исходников - blog [dot] hook</title>
  
  <meta name="description" content="Постепенно переводя часть ресурсов с Apache на nginx возникла необходимость вывода листинга файлов (autoindex on, аналог Options &#43;Indexes у Apache), но с возможностью некоторой его настройки (как минимум, это использование аналогов Apache HeaderName и ReadmeName).
В nginx этим занимается отдельный модуль под именем fancyindex, для запуска которого необходимо пересобрать весь nginx из исходников, добавив его в момент сборки.">
  <meta name="author" content="Paramtamtam">
  
  <style>
    .pace {pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}
    .pace-inactive {display:none}
    .pace .pace-progress {background:#2299dd;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:1px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"
          integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM="
          crossorigin="anonymous"></script>
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/obsidian.min.css"
        integrity="sha256-DSLpkHOyIkdP+qB1tVfhDqoTis6ZnkH6fJIYxRoMUZY="
        crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
        crossorigin="anonymous" />
  <link href="https://tarampampam.github.io/blog/css/style.css?v=1590232270" rel="stylesheet">
  
  <link rel="apple-touch-icon" sizes="180x180" href="https://tarampampam.github.io/blog/apple-touch-icon.png?v=1590232270">
  <link rel="icon" type="image/png" sizes="32x32" href="https://tarampampam.github.io/blog/favicon-32x32.png?v=1590232270">
  <link rel="icon" type="image/png" sizes="16x16" href="https://tarampampam.github.io/blog/favicon-16x16.png?v=1590232270">
  <link rel="manifest" href="https://tarampampam.github.io/blog/site.webmanifest">
  <meta name="msapplication-TileColor" content="#282b2f">
  <meta name="theme-color" content="#282b2f">
  
  </head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://tarampampam.github.io/blog/">blog [dot] hook</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/blog/adm/">Adm</a>
        </li>
        
        <li class="">
          <a href="/blog/dev/">Dev</a>
        </li>
        
        <li class="">
          <a href="/blog/docker/">Docker</a>
        </li>
        
        <li class="">
          <a href="/blog/etc/">Etc</a>
        </li>
        
        <li class="">
          <a href="/blog/hack/">Hack</a>
        </li>
        
        <li class="">
          <a href="/blog/hard/">Hard</a>
        </li>
        
        <li class="">
          <a href="/blog/mikrotik/">Mikrotik</a>
        </li>
        
        <li class="">
          <a href="/blog/my-book-live/">My-book-live</a>
        </li>
        
        <li class="">
          <a href="/blog/nix/">Nix</a>
        </li>
        
        <li class="">
          <a href="/blog/php/">Php</a>
        </li>
        
        <li class="">
          <a href="/blog/software/">Software</a>
        </li>
        
        <li class="">
          <a href="/blog/text/">Text</a>
        </li>
        
        <li class="">
          <a href="/blog/tnt/">Tnt</a>
        </li>
        
        <li class="">
          <a href="/blog/wp/">Wp</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="headline">Собираем nginx из исходников</h1>
    <p class="post-meta"><i class="fa fa-user-secret" aria-hidden="true"></i> <span itemprop="author">
        Paramtamtam
      </span> · 
      <i class="fa fa-calendar-check-o" aria-hidden="true"></i>&nbsp;<time datetime="2015-02-22"
        itemprop="datePublished">2015.2.22</time>
      &nbsp;&middot; <i class="fa fa-clock-o" aria-hidden="true"></i> 4 min
    </p>
  </header>
  <div class="post-content" itemprop="articleBody">
    
      <div class="post-featured-image">
        <img src="https://tarampampam.github.io/images/posts/nginx-wide.jpg" itemprop="image" alt="Собираем nginx из исходников" />
      </div>
    

    <div class="outdated-post" data-posted-at="2015-02-22">
      <strong>Внимание!</strong> Данный пост был опубликован более года назад и, возможно, уже утратил свою былую
      актуальность. Но это не точно.
    </div>

    <p>Постепенно переводя часть ресурсов с Apache на <strong>nginx</strong> возникла необходимость вывода листинга файлов (<code>autoindex on</code>, аналог <code>Options +Indexes</code> у Apache), но с возможностью некоторой его настройки (как минимум, это использование аналогов Apache <code>HeaderName</code> и <code>ReadmeName</code>).</p>

<p>В nginx этим занимается отдельный модуль под именем <code>fancyindex</code>, для запуска которого необходимо пересобрать весь nginx из исходников, добавив его в момент сборки.</p>

<p>Что бы не возникло проблем с текущими настройками и зависимостями, мы будем собирать точно такую-же версию, что у нас сейчас стоит. Получаем информацию об установленной версии и параметрах её сборки:</p>

<pre><code class="language-bash">$ nginx -V
nginx version: nginx/1.6.2
built by gcc 4.8.2 20140120 (Red Hat 4.8.2-16) (GCC)
...
</code></pre>

<blockquote>
<p>Можно смело обновляться на более свежую версию или ставить nginx &ldquo;на чистую&rdquo; по данной инструкции - проверено на версиях 1.6.2 и 1.9.1 (CentOS 7)</p>
</blockquote>

<p>Идем в домашний каталог (работаем под рутом) и скачиваем исходники:</p>

<pre><code class="language-bash">$ cd ~; mkdir ./nginx_src; cd ./nginx_src
$ wget http://www.nginx.org/download/nginx-1.6.2.tar.gz
$ tar -xvf nginx-1.6.2.tar.gz
$ cd nginx-1.6.2
</code></pre>

<p>Скачиваем модуль <code>fancyindex</code> и размещаем его исходники в <code>~/nginx_src/nginx-1.6.2/fancyindex/</code>:</p>

<pre><code class="language-bash">$ mkdir ./fancyindex; cd ./fancyindex/
$ wget https://github.com/aperezdc/ngx-fancyindex/archive/master.zip
$ unzip master.zip
$ mv ./ngx-fancyindex-master/* ./
$ rm -Rf ./ngx-fancyindex-master/; rm -f ./master.zip
$ cd ..
</code></pre>

<p>После этого создаем файл <code>conf.sh</code>, который у нас будет конфигурять сборку:</p>

<pre><code class="language-bash">$ touch ./conf.sh; chmod +x ./conf.sh
</code></pre>

<p>А в самом файле указываем все флаги, что были нам показаны при выводе <code>nginx -V</code>. У меня на CentOS 7 получилось следующее:</p>

<pre><code class="language-bash">#!/bin/sh

./configure\
  --add-module=./fancyindex\
  --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'\
  --prefix=/usr/share/nginx\
  --sbin-path=/usr/sbin/nginx\
  --conf-path=/etc/nginx/nginx.conf\
  --error-log-path=/var/log/nginx/error.log\
  --http-log-path=/var/log/nginx/access.log\
  --http-client-body-temp-path=/var/lib/nginx/tmp/client_body\
  --http-proxy-temp-path=/var/lib/nginx/tmp/proxy\
  --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi\
  --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi\
  --http-scgi-temp-path=/var/lib/nginx/tmp/scgi\
  --pid-path=/run/nginx.pid\
  --lock-path=/run/lock/subsys/nginx\
  --user=nginx\
  --group=nginx\
  --with-file-aio\
  --with-ipv6\
  --with-http_ssl_module\
  --with-http_spdy_module\
  --with-http_realip_module\
  --with-http_geoip_module\
  --with-http_mp4_module\
  --with-http_gunzip_module\
  --with-http_gzip_static_module\
  --with-pcre\
  --with-debug\
  --without-http_ssi_module\
  --without-http_autoindex_module\
  --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'
#  --with-http_stub_status_module\
#  --with-http_image_filter_module\
#  --with-google_perftools_module\
#  --with-http_perl_module\
#  --with-http_random_index_module\
#  --with-http_secure_link_module\
#  --with-http_degradation_module\
#  --with-http_sub_module\
#  --with-http_dav_module\
#  --with-http_flv_module\
#  --with-http_addition_module\
#  --with-http_xslt_module\
#  --with-mail\
#  --with-mail_ssl_module\
</code></pre>

<p>Некоторые опции, такие как <code>--with-mail</code> осознанно отключил, т.к. этот функционал мной не используется. Теперь пытаемся запустить:</p>

<pre><code class="language-bash">$ ./conf.sh
</code></pre>

<p>После чего смотрим вывод и гуглим причину, по которой у нас не собирается (наверняка не хватает какой-то зависимости). Мне потребовалось поставить (<strong>перед</strong> / <strong>во время</strong> сборки):</p>

<pre><code class="language-bash">$ yum install gcc gcc-c++ pcre-devel zlib-devel make openssl-devel
$ yum install rpm-build gd-devel libxslt-devel perl-ExtUtils-Embed gperftools-devel
</code></pre>

<blockquote>
<p>Для Debian систем список пакетов вероятнее всего будет таким:</p>

<pre><code class="language-bash">$ apt-get -y install build-essential zlib1g-dev libpcre3 libpcre3-dev libbz2-dev libssl-dev tar unzip
</code></pre>

<p>Небольшое отступление - в целях безопасности есть смысл скрыть настоящую сигнатуру используемого сервера. При помощи двух следующих шагов мы <a href="http://stackoverflow.com/a/246294">заменим стандартный баннер nginx-а</a>, отсылаемый при каждом запросе, и немного изменим вывод на стандартных страницах ошибок, по которым так же происходит определение используемого ПО на сервере.</p>

<p>Изменяем стандартный баннер ответа сервера (поправь строки 48 и 49):</p>

<pre><code class="language-bash">$ nano ./src/http/ngx_http_header_filter_module.c
</code></pre>

<pre><code>static char ngx_http_server_string[] = &quot;Server: SuperSecretServer&quot; CRLF;
static char ngx_http_server_full_string[] = &quot;Server: SuperSecretServer&quot; CRLF;
</code></pre>

<p>И правим вывод вывод на стандартных страницах ошибок (начиная со строки 21 и далее по тексту):</p>

<pre><code class="language-bash">$ nano ./src/http/ngx_http_special_response.c
</code></pre>

<pre><code>static u_char ngx_http_error_full_tail[] =
&quot;&lt;hr&gt;&lt;center&gt;&quot; /*NGINX_VER*/ &quot;&lt;/center&gt;&quot; CRLF
&quot;&lt;/body&gt;&quot; CRLF
&quot;&lt;/html&gt;&quot; CRLF
;

static u_char ngx_http_error_tail[] =
&quot;&lt;hr&gt;&lt;center&gt;SuperSecretServer&lt;/center&gt;&quot; CRLF
&quot;&lt;/body&gt;&quot; CRLF
&quot;&lt;/html&gt;&quot; CRLF
;
...
</code></pre>
</blockquote>

<p>И наконец таки компилируем, делаем копию конфигов и ставим:</p>

<blockquote>
<p>Не забудь - если ты пересобираешь его не первый раз, перед <code>$ make</code> выполни <code>$ make clean</code> и заново запусти <code>$ ./conf.sh</code></p>
</blockquote>

<pre><code class="language-bash">$ cp -r /etc/nginx/ ~/nginx_conf
$ make
</code></pre>

<blockquote>
<h5 id="удали-старый-nginx">Удали старый nginx!</h5>

<p>Если nginx у тебя был установлен из репозитория, то именно сейчас настал момент, когда требуется остановить работающий nginx и удалить его. Для этого выполни:</p>

<pre><code class="language-bash">$ service nginx stop
$ yum erase nginx
</code></pre>
</blockquote>

<pre><code class="language-bash">$ service nginx stop
$ make install
</code></pre>

<p>Теперь требуется создать <a href="https://gist.githubusercontent.com/tarampampam/3d165f928f2de4ed6626/raw/cbe55cb69f1af4d686a848957fe7b188e7d4b329/nginx.sh">init-скрипт</a> для nginx (<a href="http://wiki.nginx.org/RedHatNginxInitScript">источник</a>, для чего выполним следующие команды:</p>

<blockquote>
<p>Приведенный ниже скрипт актуален для ОС семейства RedHat, для других ОС есть смысл поискать или написать свой init скрипт</p>
</blockquote>

<pre><code class="language-bash">$ wget -O /etc/init.d/nginx https://goo.gl/LDrMbr
$ chmod +x /etc/init.d/nginx
</code></pre>

<p>И проверим:</p>

<pre><code class="language-bash">$ service nginx status
nginx.service - SYSV: Nginx is an HTTP(S) server, HTTP(S) reverse proxy and IMAP/POP3 proxy server
   Loaded: loaded (/etc/rc.d/init.d/nginx)
   Active: inactive (dead) since Tue 2015-06-16 13:20:07 MSK; 1s ago
  Process: 5151 ExecStop=/etc/rc.d/init.d/nginx stop (code=exited, status=0/SUCCESS)
  Process: 4759 ExecStart=/etc/rc.d/init.d/nginx start (code=exited, status=0/SUCCESS)
 Main PID: 4927 (code=exited, status=0/SUCCESS)
</code></pre>

<p>Теперь копируем конфиги обратно, запускаем, и ставим его в автозапуск при старте системы:</p>

<pre><code class="language-bash">$ cp -r ~/nginx_conf/ /etc/nginx/
$ service nginx start
$ /sbin/chkconfig nginx on
</code></pre>

<p>После этого проверяем работоспособность нашего свежесобранного сервера и удаляем резервные копии конфигов :)</p>

    
    </blockquote>
  </div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="https://tarampampam.github.io/blog/tags/bash/">bash</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/centos/">centos</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/gcc/">gcc</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/linux/">linux</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/nginx/">nginx</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/service/">service</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/source/">source</a></li>
      
    </ul>
    
  </footer>
  

  
    <div class="comments-area">
      
      <div id="utteranc-comments"></div>
      <script>
        (function () {
          window.setTimeout(function () {
            let d = document, s = d.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'tarampampam\/blog');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('crossorigin', 'anonymous');
            s.async = true;
            s.defer = true;
            d.getElementById('utteranc-comments').appendChild(s);
          }, 100);
        })();
      </script>
      

      

    
  </div>
  
</article>
</main>
<footer class="footer">
  <span>2020 &copy; Make love, not war</span>
  
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"
        integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"
        integrity="sha256-tvm0lHsuUZcOfj/0C9xJTU4OQx5KpUgxUcAXLX5kvwA="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"
        integrity="sha256-2axosoqkcFJ3cXezszojJ8/PdK8VCYVPOwNq7ersKfk="
        crossorigin="anonymous"
        data-no-instant></script>
<script data-no-instant>
  (function () {

    if (typeof hljs === 'object') {
      hljs.initHighlightingOnLoad();
    }

    let
      $toggle = document.querySelector('.menu-toggle'),
      $body = document.querySelector('body'),
      $outdated = document.querySelectorAll('.outdated-post');

    $toggle.addEventListener('click', function () {
      $body.classList.toggle('noscroll');
    }, false);

    for (var i = 0, len = $outdated.length; i < len; i++) {
      let
        $el = $outdated[i],
        now = new Date(),
        posted_at = new Date($el.getAttribute('data-posted-at')),
        diff = Math.abs(now.getTime() - posted_at.getTime()),
        days = Math.ceil(diff / (1000 * 3600 * 24));

      if (days >= 547  ) {
        $el.style.display = 'block';
        $el.style.visibility = 'visible'
      }
    }

  })();
</script>
</body>
</html>

