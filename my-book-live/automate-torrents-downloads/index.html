<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Автоматизируем свои torrent закачки - blog [dot] hook</title>
  
  <meta name="description" content="Однажды мне стало лень. Лень проверять новые серии у сериалов и ставить их на закачку :) Решил автоматизировать этот процесс при помощи rss ленты для свежих torrent-ов и клиента Transmission на &amp;ldquo;WD My Book Live&amp;rdquo;, т.к. &amp;ldquo;железка&amp;rdquo; работает сутками, и файлы с неё доступны всем гаджетам. А теперь по порядку.">
  <meta name="author" content="Paramtamtam">
  
  <style>
    .pace {pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}
    .pace-inactive {display:none}
    .pace .pace-progress {background:#2299dd;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:1px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"
          integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM="
          crossorigin="anonymous"></script>
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/obsidian.min.css"
        integrity="sha256-DSLpkHOyIkdP+qB1tVfhDqoTis6ZnkH6fJIYxRoMUZY="
        crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
        crossorigin="anonymous" />
  <link href="https://tarampampam.github.io/blog/css/style.css?v=1590232448" rel="stylesheet">
  
  <link rel="apple-touch-icon" sizes="180x180" href="https://tarampampam.github.io/blog/apple-touch-icon.png?v=1590232448">
  <link rel="icon" type="image/png" sizes="32x32" href="https://tarampampam.github.io/blog/favicon-32x32.png?v=1590232448">
  <link rel="icon" type="image/png" sizes="16x16" href="https://tarampampam.github.io/blog/favicon-16x16.png?v=1590232448">
  <link rel="manifest" href="https://tarampampam.github.io/blog/site.webmanifest">
  <meta name="msapplication-TileColor" content="#282b2f">
  <meta name="theme-color" content="#282b2f">
  
  </head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://tarampampam.github.io/blog/">blog [dot] hook</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/blog/adm/">Adm</a>
        </li>
        
        <li class="">
          <a href="/blog/dev/">Dev</a>
        </li>
        
        <li class="">
          <a href="/blog/docker/">Docker</a>
        </li>
        
        <li class="">
          <a href="/blog/etc/">Etc</a>
        </li>
        
        <li class="">
          <a href="/blog/hack/">Hack</a>
        </li>
        
        <li class="">
          <a href="/blog/hard/">Hard</a>
        </li>
        
        <li class="">
          <a href="/blog/mikrotik/">Mikrotik</a>
        </li>
        
        <li class="">
          <a href="/blog/my-book-live/">My-book-live</a>
        </li>
        
        <li class="">
          <a href="/blog/nix/">Nix</a>
        </li>
        
        <li class="">
          <a href="/blog/php/">Php</a>
        </li>
        
        <li class="">
          <a href="/blog/software/">Software</a>
        </li>
        
        <li class="">
          <a href="/blog/text/">Text</a>
        </li>
        
        <li class="">
          <a href="/blog/tnt/">Tnt</a>
        </li>
        
        <li class="">
          <a href="/blog/wp/">Wp</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="headline">Автоматизируем свои torrent закачки</h1>
    <p class="post-meta"><i class="fa fa-user-secret" aria-hidden="true"></i> <span itemprop="author">
        Paramtamtam
      </span> · 
      <i class="fa fa-calendar-check-o" aria-hidden="true"></i>&nbsp;<time datetime="2014-07-13"
        itemprop="datePublished">2014.7.13</time>
      &nbsp;&middot; <i class="fa fa-clock-o" aria-hidden="true"></i> 6 min
    </p>
  </header>
  <div class="post-content" itemprop="articleBody">
    
      <div class="post-featured-image">
        <img src="https://tarampampam.github.io/images/posts/torrent-wide.jpg" itemprop="image" alt="Автоматизируем свои torrent закачки" />
      </div>
    

    <div class="outdated-post" data-posted-at="2014-07-13">
      <strong>Внимание!</strong> Данный пост был опубликован более года назад и, возможно, уже утратил свою былую
      актуальность. Но это не точно.
    </div>

    <p>Однажды мне стало лень. Лень проверять новые серии у сериалов и ставить их на закачку :) Решил автоматизировать этот процесс при помощи rss ленты для свежих torrent-ов и клиента Transmission на &ldquo;WD My Book Live&rdquo;, т.к. &ldquo;железка&rdquo; работает сутками, и файлы с неё доступны всем гаджетам. А теперь по порядку.</p>

<h3 id="подготовка">Подготовка</h3>

<p>Запускаем ssh и ставим либу для питона по работе с RPC Transmission:</p>

<pre><code class="language-bash">$ easy_install transmissionrpc
</code></pre>

<blockquote>
<p>Это при условии, что Python 2.6.x и easy_install уже стоят</p>
</blockquote>

<h3 id="создаем-скрипт-и-настраиваем-его">Создаем скрипт и настраиваем его</h3>

<p>Создаем в /root/ скрипт <a href="https://github.com/tarampampam/scripts/blob/master/nix/get-torrents-by-rss.py"><code>gettorrensbyrss.py</code></a> следующего содержания:</p>

<pre><code class="language-python">#!/usr/bin/env python

## @editby    github.com/tarampampam
## @based on  https://github.com/soddengecko/tranmission_rss.py
##              &lt;https://github.com/soddengecko&gt;
## @project   RSS torrent downloader for Transmission-daemon
## @copyright 2014 &lt;github.com/tarampampam&gt;
## @github    https://github.com/tarampampam/scripts/nix/
## @version   0.1.4
##
## @depends   python, Transmission-daemon, python libs (feedparser, difflib,
##              urllib, urllib2, transmissionrpc, datetime, time, os, sys)

## Installation details on &quot;WD My Book Live&quot;:
## # Install ipkg
## &gt; wget http://mybookworld.wikidot.com/local--files/optware/setup-mybooklive.sh &amp;&amp; sh setup-mybooklive.sh &amp;&amp; rm -f setup-mybooklive.sh
## # Install python26 and easy_install
## &gt; ipkg update &amp;&amp; ipkg install python26 py26-setuptools
## # Install packages
## &gt; mkdir -p /tmp2 &amp;&amp; TEMP=/tmp2 easy_install feedparser transmissionrpc &amp;&amp; rm -Rf /tmp2
## # Run it:
## &gt; /opt/bin/python2.6 ./get_torrents_by_rss.py

# User details
# Add the url to your feed
feed_url = &quot;http://torrentrss.net/getrss.php?rsslink=XXXXXXX&quot;
# Download torrents from feed to this folder
down_path = &quot;/shares/Public/Films/New/&quot;
# Important - path to DIFF files (path must be writeable)
logs_path = &quot;/root/.config/gettorrentsbyrss/&quot;

hist = logs_path + &quot;rss-hist.txt&quot;		# Location of history file
inc  = logs_path + &quot;rss-inc.txt&quot;		# Location of incoming links file
diff = logs_path + &quot;rss-diff.txt&quot;		# Location of difference file
evnt = logs_path + &quot;events.log&quot;			# Location of simple events log

# Transmission RPC details
# Fill in your transmission details below
USER = 'Your_RPC_Login_Here'            # Username
PASS = 'Enter_RPC_password_here'        # Password
HOST = 'localhost'                      # The remote host
PORT = '9091'                           # The same port as used by the server

# -----------------------------------------------------------------------------
# DO NOT MODIFY BELOW THIS LINE UNLESS YOU KNOW WHAT YOU ARE DOING!!
# -----------------------------------------------------------------------------

print &quot;[i] Init libraries..&quot;

# Import some needed libraries
import feedparser
import difflib
import urllib
import urllib2
import transmissionrpc
import datetime, time
import os, sys

# Prepare for logging ---------------------------------------------------------
d = os.path.dirname(evnt)
if not os.path.exists(d):
    os.makedirs(d)
if not os.path.exists(evnt):
    file(evnt, 'w').close()
evntlog = open(evnt, 'a+b')
now = time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime())
# -----------------------------------------------------------------------------

evntlog.write(now + &quot; : Script runing\r\n&quot;)

print &quot;[i] Connect to the transmission RPC server..&quot;

# Use contents of diff file and add them to transmission via the rpc
try:
   # Connect to the transmission RPC server
   tc = transmissionrpc.Client(HOST, port=PORT, user=USER, password=PASS)
   tc.session_stats()
except:
   print &quot;[Fatal] Transmission error, check config or transmission library (root# easy_install transmissionrpc)&quot;
   evntlog.write(now + &quot; : [Fatal] Transmission error\r\n&quot;)
   evntlog.close()
   sys.exit(1)

print &quot;[i] Check for log/history/diff files..&quot;

if not os.path.exists(down_path):
    os.makedirs(down_path)

# Create the log files if they do not exist. This will prevent read/write
#   errors later on
d = os.path.dirname(hist)
if not os.path.exists(d):
    os.makedirs(d)
if not os.path.exists(hist):
    file(hist, 'w').close()

d = os.path.dirname(inc)
if not os.path.exists(d):
    os.makedirs(d)
if not os.path.exists(inc):
    file(inc, 'w').close()

d = os.path.dirname(diff)
if not os.path.exists(d):
    os.makedirs(d)
if not os.path.exists(diff):
    file(diff, 'w').close()

print &quot;[i] Parse the feed url..&quot;

# Parse the feed url given in the user details section.
feed = feedparser.parse(feed_url)
# Strip all the unnecessary data and grab the links
with open(inc, 'w+') as incoming_file:
	for post in feed.entries:
		incoming_file.write(post.link + &quot;\n&quot;)
		#post.title
		#post.link
		#post.comments
		#post.pubDate

print &quot;[i] Check the incoming file against the history..&quot;

# Check the incoming file against the history file. If there is a differece,
#   write it to the diff file.
def build_set(inc):
    # A set stores a collection of unique items.  Both adding items and
    #   searching for them are quick, so it's perfect for this application.
    found = set()

    with open(inc) as incoming:
        for line in incoming:
            # [:2] gives us the first two elements of the list.
            # Tuples, unlike lists, cannot be changed, which is a requirement
            #   for anything being stored in a set.
            found.add(tuple(sorted(line.split()[:2])))

    return found

set_more = build_set(inc)
set_del = build_set(hist)

with open(diff, 'w+') as difference:
   # Using with to open files ensures that they are properly closed, even if
   #   the code raises an exception.

   for res in (set_more - set_del):
      # The - computes the elements in set_more not in set_del.
      difference.write(&quot; &quot;.join(res) + &quot;\n&quot;)


# Open the diff file and add the contents (links) to transmission
f = open(diff)
for line in iter(f):
   try:
      now = time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime())

      # Add torrents to transmission via the rpc
      tc.add_torrent(line, download_dir=down_path)
      print &quot;   [t] Add task: &quot; + line.strip()
      time.sleep(5)

      evntlog.write(now + &quot; : Added torrent (&quot; + line.strip() + &quot;)\r\n&quot;)
   except:
      print &quot;   [Error] Adding torrent error\n&quot;
      now = time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime())
      evntlog.write(now + &quot; : Adding torrent error (&quot; + line.strip() + &quot;)\r\n&quot;)
      pass
f.close()

print &quot;[i] Move contents of diff file and append to history file..&quot;

# Move contents of diff file and append to history file, then reset diff file
# Open diff file, read contents then close file
diff_file = open(diff, &quot;r&quot;)
diff_data = diff_file.read()
diff_file.close()
# Open history file and appaend diff file data
hist_file = open(hist, &quot;a&quot;)
hist_file.write(diff_data)
hist_file.close()

print &quot;[i] Finishing..&quot;

# Now we have finished with the diff and inc files, we open them, write in
#   nothing and resave the file
open(diff, 'w').close()
open(inc, 'w').close()
evntlog.close()

print &quot;[i] Complete&quot;
</code></pre>

<p>И в самом начале вносим все необходимые коррективы. Для генерации самой ленты полно сервисов, но пока остановился на <a href="http://torrentrss.net/mydownloads.html">torrentrss.net</a>. Ссылку на ленту берем из панели:</p>

<p><img src="https://hsto.org/files/84d/b72/ce7/84db72ce7f474c5fa38dc3faea58b69d.png" alt="image" /></p>

<h3 id="запускаем">Запускаем</h3>

<p>После этого даем права на запуск, и делаем тестовый запуск:</p>

<pre><code class="language-bash">$ chmod +x gettorrentsbyrss.py
$ python gettorrentsbyrss.py
</code></pre>

<p>И в ответ должны увидеть что то в духе:</p>

<pre><code class="language-bash">[i] Init libraries..
[i] Connect to the transmission RPC server..
[i] Check for log/history/diff files..
[i] Parse the feed url..
[i] Check the incoming file against the history..
   [t] Add task: http://some_urt/to_torrent_is_here
[i] Move contents of diff file and append to history file..
[i] Finishing..
[i] Complete
</code></pre>

<h3 id="добавляем-в-крон">Добавляем в крон</h3>

<p>После этого проверяем торрент клиент - добавились ли новые задачи, и если да - то всё хорошо, можно ставить запуск в крон (запускать ровно в 7,8,9..23 часов; ночью надо отдыхать):</p>

<pre><code class="language-bash">$ crontab -e
0 7-23 * * * /root/gettorrentsbyrss.py
</code></pre>

<p>В случае же возникновения ошибок следует искать их причину. Вот при каких условиях всё работает у меня:</p>

<pre><code class="language-bash">$ python -V
Python 2.6.6

$ cat /proc/version
Linux version 2.6.32.11-svn70860 (steveh@steveh-pc) (gcc version 4.2.2)

$ cat /etc/issue
Debian GNU/Linux 5.0 n l

$ /opt/bin/transmission-daemon -V
transmission-daemon 2.82 (14160)
</code></pre>

    
    </blockquote>
  </div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="https://tarampampam.github.io/blog/tags/cron/">cron</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/python/">python</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/rss/">rss</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/torren/">torren</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/transmission/">transmission</a></li>
      
    </ul>
    
  </footer>
  

  
    <div class="comments-area">
      
      <div id="utteranc-comments"></div>
      <script>
        (function () {
          window.setTimeout(function () {
            let d = document, s = d.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'tarampampam\/blog');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('crossorigin', 'anonymous');
            s.async = true;
            s.defer = true;
            d.getElementById('utteranc-comments').appendChild(s);
          }, 100);
        })();
      </script>
      

      

    
  </div>
  
</article>
</main>
<footer class="footer">
  <span>2020 &copy; Make love, not war</span>
  
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"
        integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"
        integrity="sha256-tvm0lHsuUZcOfj/0C9xJTU4OQx5KpUgxUcAXLX5kvwA="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"
        integrity="sha256-2axosoqkcFJ3cXezszojJ8/PdK8VCYVPOwNq7ersKfk="
        crossorigin="anonymous"
        data-no-instant></script>
<script data-no-instant>
  (function () {

    if (typeof hljs === 'object') {
      hljs.initHighlightingOnLoad();
    }

    let
      $toggle = document.querySelector('.menu-toggle'),
      $body = document.querySelector('body'),
      $outdated = document.querySelectorAll('.outdated-post');

    $toggle.addEventListener('click', function () {
      $body.classList.toggle('noscroll');
    }, false);

    for (var i = 0, len = $outdated.length; i < len; i++) {
      let
        $el = $outdated[i],
        now = new Date(),
        posted_at = new Date($el.getAttribute('data-posted-at')),
        diff = Math.abs(now.getTime() - posted_at.getTime()),
        days = Math.ceil(diff / (1000 * 3600 * 24));

      if (days >= 547  ) {
        $el.style.display = 'block';
        $el.style.visibility = 'visible'
      }
    }

  })();
</script>
</body>
</html>

