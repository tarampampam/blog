<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Deploy to Docker Swarm - blog [dot] hook</title>
  
  <meta name="description" content=" This post is translation of part of documentation
 deploy  Version 3 only.
 Specify configuration related to the deployment and running of services. This only takes effect when deploying to a swarm with docker stack deploy, and is ignored by docker-compose up and docker-compose run.
version: &#39;3&#39; services: redis: image: redis:alpine deploy: replicas: 6 update_config: parallelism: 2 delay: 10s restart_policy: condition: on-failure ">
  <meta name="author" content="Paramtamtam">
  
  <style>
    .pace {pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}
    .pace-inactive {display:none}
    .pace .pace-progress {background:#2299dd;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:1px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"
          integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM="
          crossorigin="anonymous"></script>
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/obsidian.min.css"
        integrity="sha256-DSLpkHOyIkdP+qB1tVfhDqoTis6ZnkH6fJIYxRoMUZY="
        crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
        crossorigin="anonymous" />
  <link href="https://blog.hook.sh/css/style.css?v=1590247523" rel="stylesheet">
  
  <link rel="apple-touch-icon" sizes="180x180" href="https://blog.hook.sh/apple-touch-icon.png?v=1590247523">
  <link rel="icon" type="image/png" sizes="32x32" href="https://blog.hook.sh/favicon-32x32.png?v=1590247523">
  <link rel="icon" type="image/png" sizes="16x16" href="https://blog.hook.sh/favicon-16x16.png?v=1590247523">
  <link rel="manifest" href="https://blog.hook.sh/site.webmanifest">
  <meta name="msapplication-TileColor" content="#282b2f">
  <meta name="theme-color" content="#282b2f">
  
  </head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://blog.hook.sh/">blog [dot] hook</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/en/docker/">Docker</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="headline">Deploy to Docker Swarm</h1>
    <p class="post-meta"><i class="fa fa-user-secret" aria-hidden="true"></i> <span itemprop="author">
        Paramtamtam
      </span> · 
      <i class="fa fa-calendar-check-o" aria-hidden="true"></i>&nbsp;<time datetime="2018-10-15"
        itemprop="datePublished">2018.10.15</time>
      &nbsp;&middot; <i class="fa fa-clock-o" aria-hidden="true"></i> 6 min
    </p>
  </header>
  <div class="post-content" itemprop="articleBody">
    
      <div class="post-featured-image">
        <img src="https://blog.hook.sh//images/posts/docker-in-clouds-wide.png" itemprop="image" alt="Deploy to Docker Swarm" />
      </div>
    

    <div class="outdated-post" data-posted-at="2018-10-15">
      <strong>Внимание!</strong> Данный пост был опубликован более года назад и, возможно, уже утратил свою былую
      актуальность. Но это не точно.
    </div>

    <blockquote>
<p>This post is translation of <a href="https://docs.docker.com/compose/compose-file/#deploy">part of documentation</a></p>
</blockquote>

<h2 id="deploy"><code>deploy</code></h2>

<blockquote>
<p><a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-3">Version 3</a> only.</p>
</blockquote>

<p>Specify configuration related to the deployment and running of services. This only takes effect when deploying to a <a href="https://docs.docker.com/engine/swarm/">swarm</a> with <a href="https://docs.docker.com/engine/reference/commandline/stack_deploy/">docker stack deploy</a>, and is ignored by <code>docker-compose up</code> and <code>docker-compose run</code>.</p>

<pre><code class="language-yaml">version: '3'
services:
  redis:
    image: redis:alpine
    deploy:
      replicas: 6
      update_config:
        parallelism: 2
        delay: 10s
      restart_policy:
        condition: on-failure
</code></pre>

<p>Several sub-options are available:</p>

<h3 id="endpoint-mode"><code>ENDPOINT_MODE</code></h3>

<p>Specify a service discovery method for external clients connecting to a swarm.</p>

<blockquote>
<p><a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-3">Version 3.3</a> only.</p>
</blockquote>

<ul>
<li><p><code>endpoint_mode: vip</code> - Docker assigns the service a virtual IP (VIP) that acts as the “front end” for clients to reach the service on a network. Docker routes requests between the client and available worker nodes for the service, without client knowledge of how many nodes are participating in the service or their IP addresses or ports. (This is the default.)</p></li>

<li><p><code>endpoint_mode: dnsrr</code> - DNS round-robin (DNSRR) service discovery does not use a single virtual IP. Docker sets up DNS entries for the service such that a DNS query for the service name returns a list of IP addresses, and the client connects directly to one of these. DNS round-robin is useful in cases where you want to use your own load balancer, or for Hybrid Windows and Linux applications.</p>

<pre><code class="language-yaml">version: &quot;3.3&quot;

services:
wordpress:
image: wordpress
ports:
  - &quot;8080:80&quot;
networks:
  - overlay
deploy:
  mode: replicated
  replicas: 2
  endpoint_mode: vip

mysql:
image: mysql
volumes:
   - db-data:/var/lib/mysql/data
networks:
   - overlay
deploy:
  mode: replicated
  replicas: 2
  endpoint_mode: dnsrr

volumes:
db-data:

networks:
overlay:
</code></pre></li>
</ul>

<p>The options for <code>endpoint_mode</code> also work as flags on the swarm mode CLI command <a href="https://docs.docker.com/engine/reference/commandline/service_create/">docker service create</a>. For a quick list of all swarm related <code>docker</code> commands, see <a href="https://docs.docker.com/engine/swarm/#swarm-mode-key-concepts-and-tutorial">Swarm mode CLI commands</a>.</p>

<p>To learn more about service discovery and networking in swarm mode, see <a href="https://docs.docker.com/network/overlay/">Configure service discovery</a> in the swarm mode topics.</p>

<h3 id="labels"><code>LABELS</code></h3>

<p>Specify labels for the service. These labels are <em>only</em> set on the service, and <em>not</em> on any containers for the service.</p>

<pre><code class="language-yaml">version: &quot;3&quot;
services:
  web:
    image: web
    deploy:
      labels:
        com.example.description: &quot;This label will appear on the web service&quot;
</code></pre>

<p>To set labels on containers instead, use the <code>labels</code> key outside of <code>deploy</code>:</p>

<pre><code class="language-yaml">version: &quot;3&quot;
services:
  web:
    image: web
    labels:
      com.example.description: &quot;This label will appear on all containers for the web service&quot;
</code></pre>

<h3 id="mode"><code>MODE</code></h3>

<p>Either <code>global</code> (exactly one container per swarm node) or <code>replicated</code> (a specified number of containers). The default is <code>replicated</code>. (To learn more, see <a href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/services/#replicated-and-global-services">Replicated and global services</a> in the <a href="https://docs.docker.com/engine/swarm/">swarm</a> topics.)</p>

<pre><code class="language-yaml">version: '3'
services:
  worker:
    image: dockersamples/examplevotingapp_worker
    deploy:
      mode: global
</code></pre>

<h3 id="placement"><code>PLACEMENT</code></h3>

<p>Specify placement of constraints and preferences. See the docker service create documentation for a full description of the syntax and available types of <a href="https://docs.docker.com/engine/reference/commandline/service_create/#specify-service-constraints-constraint">constraints</a> and <a href="https://docs.docker.com/engine/reference/commandline/service_create/#specify-service-placement-preferences-placement-pref">preferences</a>.</p>

<pre><code class="language-yaml">version: '3.3'
services:
  db:
    image: postgres
    deploy:
      placement:
        constraints:
          - node.role == manager
          - engine.labels.operatingsystem == ubuntu 14.04
        preferences:
          - spread: node.labels.zone
</code></pre>

<h3 id="replicas"><code>REPLICAS</code></h3>

<p>If the service is <code>replicated</code> (which is the default), specify the number of containers that should be running at any given time.</p>

<pre><code class="language-yaml">version: '3'
services:
  worker:
    image: dockersamples/examplevotingapp_worker
    networks:
      - frontend
      - backend
    deploy:
      mode: replicated
      replicas: 6
</code></pre>

<h3 id="resources"><code>RESOURCES</code></h3>

<p>Configures resource constraints.</p>

<blockquote>
<p><strong>Note:</strong> This replaces the <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#cpu-and-other-resources">older resource constraint options</a> for non swarm mode in Compose files prior to version 3 (<code>cpu_shares</code>, <code>cpu_quota</code>, <code>cpuset</code>, <code>mem_limit</code>, <code>memswap_limit</code>, <code>mem_swappiness</code>), as described in <a href="https://docs.docker.com/compose/compose-file/compose-versioning/#upgrading">Upgrading version 2.x to 3.x</a>.</p>
</blockquote>

<p>Each of these is a single value, analogous to its <a href="https://docs.docker.com/engine/reference/commandline/service_create/">docker service create</a> counterpart.</p>

<p>In this general example, the <code>redis</code> service is constrained to use no more than 50M of memory and <code>0.50</code> (50%) of available processing time (CPU), and has <code>20M</code> of memory and <code>0.25</code> CPU time reserved (as always available to it).</p>

<pre><code class="language-yaml">version: '3'
services:
  redis:
    image: redis:alpine
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 50M
        reservations:
          cpus: '0.25'
          memory: 20M
</code></pre>

<p>The topics below describe available options to set resource constraints on services or containers in a swarm.</p>

<blockquote>
<p><strong>Looking for options to set resources on non swarm mode containers?</strong></p>

<p>The options described here are specific to the <code>deploy</code> key and swarm mode. If you want to set resource constraints on non swarm deployments, use <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#cpu-and-other-resources">Compose file format version 2 CPU, memory, and other resource options</a>. If you have further questions, refer to the discussion on the GitHub issue <a href="https://github.com/docker/compose/issues/4513">docker/compose/4513</a>.</p>
</blockquote>

<h4 id="out-of-memory-exceptions-oome">Out Of Memory Exceptions (OOME)</h4>

<p>If your services or containers attempt to use more memory than the system has available, you may experience an Out Of Memory Exception (OOME) and a container, or the Docker daemon, might be killed by the kernel OOM killer. To prevent this from happening, ensure that your application runs on hosts with adequate memory and see <a href="https://docs.docker.com/engine/admin/resource_constraints/#understand-the-risks-of-running-out-of-memory">Understand the risks of running out of memory</a>.</p>

<h3 id="restart-policy"><code>RESTART_POLICY</code></h3>

<p>Configures if and how to restart containers when they exit. Replaces <code>restart</code>.</p>

<ul>
<li><code>condition</code>: One of <code>none</code>, <code>on-failure</code> or <code>any</code> (default: <code>any</code>).</li>
<li><code>delay</code>: How long to wait between restart attempts, specified as a <a href="https://docs.docker.com/compose/compose-file/#specifying-durations">duration</a> (default: 0).</li>
<li><code>max_attempts</code>: How many times to attempt to restart a container before giving up (default: never give up). If the restart does not succeed within the configured <code>window</code>, this attempt doesn’t count toward the configured <code>max_attempts</code> value. For example, if <code>max_attempts</code> is set to ‘2’, and the restart fails on the first attempt, more than two restarts may be attempted.</li>

<li><p><code>window</code>: How long to wait before deciding if a restart has succeeded, specified as a <a href="https://docs.docker.com/compose/compose-file/#specifying-durations">duration</a> (default: decide immediately).</p>

<pre><code class="language-yaml">version: &quot;3&quot;
services:
redis:
image: redis:alpine
deploy:
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
    window: 120s
</code></pre></li>
</ul>

<h3 id="rollback-config"><code>ROLLBACK_CONFIG</code></h3>

<blockquote>
<p><a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-37">Version 3.7 file format</a> and up</p>
</blockquote>

<p>Configures how the service should be rollbacked in case of a failing update.</p>

<ul>
<li><code>parallelism</code>: The number of containers to rollback at a time. If set to 0, all containers rollback simultaneously.</li>
<li><code>delay</code>: The time to wait between each container group’s rollback (default 0s).</li>
<li><code>failure_action</code>: What to do if a rollback fails. One of <code>continue</code> or <code>pause</code> (default <code>pause</code>)</li>
<li><code>monitor</code>: Duration after each task update to monitor for failure <code>(ns|us|ms|s|m|h)</code> (default <code>0s</code>).</li>
<li><code>max_failure_ratio</code>: Failure rate to tolerate during a rollback (default 0).</li>
<li><code>order</code>: Order of operations during rollbacks. One of <code>stop-first</code> (old task is stopped before starting new one), or <code>start-first</code> (new task is started first, and the running tasks briefly overlap) (default <code>stop-first</code>).</li>
</ul>

<h3 id="update-config"><code>UPDATE_CONFIG</code></h3>

<p>Configures how the service should be updated. Useful for configuring rolling updates.</p>

<ul>
<li><code>parallelism</code>: The number of containers to update at a time.</li>
<li><code>delay</code>: The time to wait between updating a group of containers.</li>
<li><code>failure_action</code>: What to do if an update fails. One of <code>continue</code>, <code>rollback</code>, or <code>pause</code> (default: <code>pause</code>).</li>
<li><code>monitor</code>: Duration after each task update to monitor for failure <code>(ns|us|ms|s|m|h)</code> (default <code>0s</code>).</li>
<li><code>max_failure_ratio</code>: Failure rate to tolerate during an update.</li>
<li><code>order</code>: Order of operations during updates. One of <code>stop-first</code> (old task is stopped before starting new one), or <code>start-first</code> (new task is started first, and the running tasks briefly overlap) (default <code>stop-first</code>). <strong>Note:</strong> Only supported for v3.4 and higher.</li>
</ul>

<blockquote>
<p><strong>Note:</strong> order is only supported for v3.4 and higher of the compose file format.</p>
</blockquote>

<pre><code class="language-yaml">version: '3.4'
services:
  vote:
    image: dockersamples/examplevotingapp_vote:before
    depends_on:
      - redis
    deploy:
      replicas: 2
      update_config:
        parallelism: 2
        delay: 10s
        order: stop-first
</code></pre>

<h3 id="not-supported-for-docker-stack-deploy">NOT SUPPORTED FOR <code>DOCKER STACK DEPLOY</code></h3>

<p>The following sub-options (supported for <code>docker-compose up</code> and <code>docker-compose run</code>) are <em>not supported</em> for <code>docker stack deploy</code> or the <code>deploy</code> key.</p>

<ul>
<li><code>build</code></li>
<li><code>cgroup_parent</code></li>
<li><code>container_name</code></li>
<li><code>devices</code></li>
<li><code>tmpfs</code></li>
<li><code>external_links</code></li>
<li><code>links</code></li>
<li><code>network_mode</code></li>
<li><code>restart</code></li>
<li><code>security_opt</code></li>
<li><code>stop_signal</code></li>
<li><code>sysctls</code></li>
<li><code>userns_mode</code></li>
</ul>

<blockquote>
<p><strong>Tip:</strong> See the section on <a href="https://docs.docker.com/compose/compose-file/#volumes-for-services-swarms-and-stack-files">how to configure volumes for services, swarms, and docker-stack.yml files</a>. Volumes are supported but to work with swarms and services, they must be configured as named volumes or associated with services that are constrained to nodes with access to the requisite volumes.</p>
</blockquote>

    
    <blockquote>
      <strong>This post translated into:</strong>
      <ul>
        
        <li>
          <a href="https://blog.hook.sh/docker/compose-deploy/">Деплой на Docker Swarm (ru)</a>
        </li>
        
      </ul>
      
    </blockquote>
  </div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="https://blog.hook.sh/tags/linux/">linux</a></li>
      
      <li><a href="https://blog.hook.sh/tags/deploy/">deploy</a></li>
      
      <li><a href="https://blog.hook.sh/tags/docker-compose/">docker-compose</a></li>
      
      <li><a href="https://blog.hook.sh/tags/docker/">docker</a></li>
      
      <li><a href="https://blog.hook.sh/tags/devops/">devops</a></li>
      
    </ul>
    
  </footer>
  

  
    <div class="comments-area">
      
      <div id="utteranc-comments"></div>
      <script>
        (function () {
          window.setTimeout(function () {
            let d = document, s = d.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'tarampampam\/blog');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('theme', 'photon-dark');
            s.async = true;
            s.defer = true;
            d.getElementById('utteranc-comments').appendChild(s);
          }, 100);
        })();
      </script>
      

      

    
  </div>
  
</article>
</main>
<footer class="footer">
  <span>2020 &copy; Make love, not war</span>
  
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"
        integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/routeros.min.js"
        integrity="sha256-OKUUrep5sRJC/VrDnr9rTdY7XR5M/KJ+VfoWqf8Hsic="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"
        integrity="sha256-tvm0lHsuUZcOfj/0C9xJTU4OQx5KpUgxUcAXLX5kvwA="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"
        integrity="sha256-2axosoqkcFJ3cXezszojJ8/PdK8VCYVPOwNq7ersKfk="
        crossorigin="anonymous"
        data-no-instant></script>
<script data-no-instant>
  (function () {

    if (typeof hljs === 'object') {
      hljs.initHighlightingOnLoad();
    }

    let
      $toggle = document.querySelector('.menu-toggle'),
      $body = document.querySelector('body'),
      $outdated = document.querySelectorAll('.outdated-post');

    $toggle.addEventListener('click', function () {
      $body.classList.toggle('noscroll');
    }, false);

    for (var i = 0, len = $outdated.length; i < len; i++) {
      let
        $el = $outdated[i],
        now = new Date(),
        posted_at = new Date($el.getAttribute('data-posted-at')),
        diff = Math.abs(now.getTime() - posted_at.getTime()),
        days = Math.ceil(diff / (1000 * 3600 * 24));

      if (days >= 547  ) {
        $el.style.display = 'block';
        $el.style.visibility = 'visible'
      }
    }

  })();
</script>
</body>
</html>

