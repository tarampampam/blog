<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Web-gui для wget (light) - blog [dot] hook</title>
  
  <meta name="description" content=" Данная статья является копией публикации на хабре
 Ранее здесь находилось описание возможных ситуаций, когда данное решение могло бы вам понадобиться, но давайте его опустим. Возможность удобного создания удаленных закачек, которые выполняются привычным wget-ом (можно спокойно увидеть их список при помощи ps), с отображением прогресса — идея не новая. И даже есть некоторые решения, но не актуальные, так как более 5 лет никем не поддерживаются.">
  <meta name="author" content="Paramtamtam">
  
  <style>
    .pace {pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}
    .pace-inactive {display:none}
    .pace .pace-progress {background:#2299dd;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:1px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"
          integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM="
          crossorigin="anonymous"></script>
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/obsidian.min.css"
        integrity="sha256-DSLpkHOyIkdP+qB1tVfhDqoTis6ZnkH6fJIYxRoMUZY="
        crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
        crossorigin="anonymous" />
  <link href="https://blog.hook.sh/css/style.css?v=1590247523" rel="stylesheet">
  
  <link rel="apple-touch-icon" sizes="180x180" href="https://blog.hook.sh/apple-touch-icon.png?v=1590247523">
  <link rel="icon" type="image/png" sizes="32x32" href="https://blog.hook.sh/favicon-32x32.png?v=1590247523">
  <link rel="icon" type="image/png" sizes="16x16" href="https://blog.hook.sh/favicon-16x16.png?v=1590247523">
  <link rel="manifest" href="https://blog.hook.sh/site.webmanifest">
  <meta name="msapplication-TileColor" content="#282b2f">
  <meta name="theme-color" content="#282b2f">
  
  </head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://blog.hook.sh/">blog [dot] hook</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/adm/">Adm</a>
        </li>
        
        <li class="">
          <a href="/dev/">Dev</a>
        </li>
        
        <li class="">
          <a href="/docker/">Docker</a>
        </li>
        
        <li class="">
          <a href="/etc/">Etc</a>
        </li>
        
        <li class="">
          <a href="/hack/">Hack</a>
        </li>
        
        <li class="">
          <a href="/hard/">Hard</a>
        </li>
        
        <li class="">
          <a href="/mikrotik/">Mikrotik</a>
        </li>
        
        <li class="">
          <a href="/my-book-live/">My-book-live</a>
        </li>
        
        <li class="">
          <a href="/nix/">Nix</a>
        </li>
        
        <li class="">
          <a href="/php/">Php</a>
        </li>
        
        <li class="">
          <a href="/software/">Software</a>
        </li>
        
        <li class="">
          <a href="/text/">Text</a>
        </li>
        
        <li class="">
          <a href="/tnt/">Tnt</a>
        </li>
        
        <li class="">
          <a href="/wp/">Wp</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="headline">Web-gui для wget (light)</h1>
    <p class="post-meta"><i class="fa fa-user-secret" aria-hidden="true"></i> <span itemprop="author">
        Paramtamtam
      </span> · 
      <i class="fa fa-calendar-check-o" aria-hidden="true"></i>&nbsp;<time datetime="2014-08-25"
        itemprop="datePublished">2014.8.25</time>
      &nbsp;&middot; <i class="fa fa-clock-o" aria-hidden="true"></i> 4 min
    </p>
  </header>
  <div class="post-content" itemprop="articleBody">
    
      <div class="post-featured-image">
        <img src="https://blog.hook.sh//images/posts/wget-webgui-wide.jpg" itemprop="image" alt="Web-gui для wget (light)" />
      </div>
    

    <div class="outdated-post" data-posted-at="2014-08-25">
      <strong>Внимание!</strong> Данный пост был опубликован более года назад и, возможно, уже утратил свою былую
      актуальность. Но это не точно.
    </div>

    <blockquote>
<p>Данная статья является копией <a href="https://habr.com/post/234353/">публикации на хабре</a></p>
</blockquote>

<p>Ранее здесь находилось описание возможных ситуаций, когда данное решение могло бы вам понадобиться, но давайте его опустим. Возможность удобного создания удаленных закачек, которые выполняются привычным wget-ом (можно спокойно увидеть их список при помощи <strong>ps</strong>), с отображением прогресса — идея не новая. И даже есть <a href="http://exir.ru/wget4web/screen.htm">некоторые</a> <a href="http://sourceforge.net/projects/download-webgui/files/?source=navbar">решения</a>, но не актуальные, так как более 5 лет никем не поддерживаются.</p>

<p>Для торрентов всё просто и тривиально — ставим Transmission или любой аналогичный клиент с веб-мордой. Но для ссылок на простые файлы/страницы нужно что-то своё. Вот короткий список задач, которые меня подтолкнули к написанию оного:</p>

<ul>
<li>Смотрю фильм онлайн при помощи планшета, но появляются дела и надо бы его сохранить, чтоб досмотреть позже;</li>
<li>На удаленный сервер надо скачать файл, и приходится запускать терминал каждый раз;</li>
<li>Надо бы скачать образ свежего linuxmint, но на домашний NAS, а не ноутбук, работая за которым пришла эта идея;</li>
<li>Во время серфинга часто возникает задача сохранить файл и расшарить его.</li>
</ul>

<p>Если вам стало интересно — добро пожаловать под кат:</p>

<h4 id="системные-требования">Системные требования</h4>

<p>Веб-интерфейс построен на Javascript + css3 с клиентской стороны, и php (выбран как наиболее популярный) с серверной. Для полноценной работы потребуется:</p>

<ul>
<li><code>*nix</code> (по крайней мере писалось именно под эту платформу, для запуска под другой потребуются рабочие порты <code>wget</code>, <code>ps</code> и <code>kill</code>);</li>
<li><code>php5.x</code> (скорее всего работать будет и на php4.x, по к моменту публикации это протестировано не было);</li>
<li>Браузер с поддержкой <code>Javascript</code> (и очень желательно — с поддержкой <code>css3</code>).</li>
</ul>

<h4 id="особенности-и-настройки-серверной-части">Особенности и настройки серверной части</h4>

<p>Как уже было сказано выше — в роли серверной части выступает скрипт, написанный на php. Он выполняет следующие задачи:</p>

<ul>
<li>Получение информации о запущенных задачах;</li>
<li>Отмена запущенных задач;</li>
<li>Добавление новых задач;</li>
<li>Возвращение результатов в JSON формате.</li>
</ul>

<p>Для своей работы ему требуются <code>ps</code>, <code>wget</code> и <code>kill</code> соответственно. Для получения значения состояния закачки (на сколько процентов завершена) используется следующий алгоритм:</p>

<ul>
<li>Задачи wget запускаются с флагами <code>--background</code> и <code>--progress=bar:force</code>;</li>
<li>Вывод лога загрузки производится в файл, установленный в параметре <code>--output-file=FILE</code>;</li>
<li>При запросе состояния задач с помощью <code>ps -ax</code> получаем путь к файлу, установленный в <code>--output-file=FILE</code>;</li>
<li>Читаем крайнюю строку этого файла, получая регуляркой из него искомое значение.</li>
</ul>

<p>Путь для временных лог-файлов устанавливается в строке</p>

<pre><code class="language-php">define(&quot;tmp_path&quot;, &quot;/tmp&quot;);
</code></pre>

<p>Путь до директории, в которую будет происходить сохранение всех загружаемых файлов устанавливается в строке</p>

<pre><code class="language-php">define(&quot;download_path&quot;, BASEPATH.&quot;/downloads&quot;);
</code></pre>

<p>Доступно удобное указание путей до <code>ps</code>, <code>wget</code> и <code>kill</code>. Для этого достаточно убрать комментарий вначале строки и указать свой путь, например:</p>

<pre><code class="language-php">define(&quot;wget&quot;, &quot;/usr/bin/wget&quot;);
</code></pre>

<p>Возможна установка ограничения на скорость закачки из секции настроек. За это отвечает строка</p>

<pre><code class="language-php">define(&quot;wget_download_limit&quot;, &quot;1024&quot;);
</code></pre>

<p>Если оставить её закомментированной — никакого ограничения не будет.</p>

<p>Для определения в списке задачи запущенной через GUI от любой другой используется определенный флаг, уникальный для GUI. Он установлен в строке:</p>

<pre><code class="language-php">define(&quot;wget_secret_flag&quot;, &quot;--max-redirect=4321&quot;);
</code></pre>

<p>И его менять без необходимости не надо. Кстати, если хотите чтоб другие ваши задачи, запущенные из терминала отображались в веб-интерфейсе — достаточно как раз этот параметр к ним и добавить. Но не забывайте, что есть ещё и некоторые другие параметры, не менее обязательные (в зависимости от настроек).</p>

<p>Постарался написать с максимально экономичным отношением к ресурсам и минимальной зависимостью от системы, но большим опытом в php не обладаю, поэтому — буду признателен рекомендациям по оптимизации.</p>

<p>Скрипт отвечает как на POST, так и GET запросы. Разницы между ними нет. Так же отвечает на параметры, переданные в командной строке. Например: <code>php ./rpc.php get_list</code> или <code>php ./rpc.php add_task http://goo.gl/5Qi0Xs</code>.</p>

<h5 id="пример-post-запроса-и-json-ответа">Пример POST-запроса и Json ответа:</h5>

<pre><code class="language-bash">Request:
192.168.1.2/wget/rpc.php?action=add_task&amp;url=http://mirror.yandex.ru/linuxmint/stable/17/linuxmint-17-cinnamon-dvd-64bit.iso
Answer:
{
    status: 1,
    msg: &quot;Task added&quot;,
    id: 10910
}

Request:
192.168.1.2/wget/rpc.php?action=get_list
Answer:
{
    status: 1,
    msg: &quot;Active tasks list&quot;,
    tasks: [
        {
            url: &quot;mirror.yandex.ru/linuxmint/stable/17/linuxmint-17-cinnamon-dvd-64bit.iso&quot;,
            progress: 95,
            id: 10910
        }
    ]
}
</code></pre>

<h4 id="особенности-и-настройки-клиентской-части">Особенности и настройки клиентской части</h4>

<p>Не используются «новые html5 теги», но используются свойства css3 для оформления прогресс-бара загрузок и адаптива. Дизайн выполнен в минималистичном стиле. При отсутствии задач в центре страницы располагается поле для добавления адреса закачки, если задачи имеются — это поле смещается вверх страницы, и ниже располагаются задачи.</p>

<p>Все запросы — асинхронные (без перезагрузки страницы). Дизайн страницы — адаптивный:</p>

<p><img src="https://hsto.org/files/479/aec/f73/479aecf737f647e485fb325671fe6df5.png" alt="Screenshot" /></p>

<p>Изменение состояния отображается также в заголовке вкладки (окна):</p>

<p><img src="https://hsto.org/files/e8c/78d/52f/e8c78d52ff494d0b9f6d7aa56bf957b8.png" alt="Screenshot" /></p>

<p>В нижней части страницы располагается javascript-закладка («Download this»), переместив которую в панель закладок браузера можно одним кликом добавлять новые задачи (при клике будет добавлена активная вкладка; если открыта вкладка с видео-файлом и будет нажата эта «закладка» на панели закладок — будет добавлена задача на скачивание этого видео-файла):</p>

<p><img src="https://hsto.org/files/462/4d0/f9c/4624d0f9c3494fee9987e4ba757a423b.png" alt="Screenshot" /></p>

<p>Весь javascript код документа расположен в файле core.js. В верхней его части располагаются основные настройки.</p>

<p>Описывать функциональные моменты смысла особого не вижу, но скажу — функции разделены на логические группы, скрипт <strong>не</strong> минифицирован, комментарии имеют место быть.</p>

<p>При нажатии на F5 происходит принудительное обновление задач, страница перезагружается только по нажатию на кнопку обновления в браузере.</p>

<h4 id="установка">Установка</h4>

<ul>
<li>Скачать или склонировать крайнюю версию репозитория;</li>
<li>Распаковать в директорию, доступную «извне»;</li>
<li>Изменить путь в «rpc.php»: <code>define(&quot;download_path&quot;, BASEPATH.&quot;/downloads&quot;);</code></li>
<li>Открыть в браузере, проверить работоспособность. В случае возникновения ошибок — <a href="https://github.com/tarampampam/wget-gui-light/issues/new">задайте вопрос, сопроводив его всей отладочной информацией</a>.</li>
</ul>

<h4 id="ссылки">Ссылки</h4>

<ul>
<li><a href="https://github.com/tarampampam/wget-gui-light/archive/master.zip">Скачать</a></li>
<li><a href="https://github.com/tarampampam/wget-gui-light">GitHub</a></li>
</ul>

    
    </blockquote>
  </div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="https://blog.hook.sh/tags/ajax/">ajax</a></li>
      
      <li><a href="https://blog.hook.sh/tags/bash/">bash</a></li>
      
      <li><a href="https://blog.hook.sh/tags/css/">css</a></li>
      
      <li><a href="https://blog.hook.sh/tags/gui/">gui</a></li>
      
      <li><a href="https://blog.hook.sh/tags/habr/">habr</a></li>
      
      <li><a href="https://blog.hook.sh/tags/linux/">linux</a></li>
      
      <li><a href="https://blog.hook.sh/tags/php/">php</a></li>
      
      <li><a href="https://blog.hook.sh/tags/wget/">wget</a></li>
      
    </ul>
    
  </footer>
  

  
    <div class="comments-area">
      
      <div id="utteranc-comments"></div>
      <script>
        (function () {
          window.setTimeout(function () {
            let d = document, s = d.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'tarampampam\/blog');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('theme', 'photon-dark');
            s.async = true;
            s.defer = true;
            d.getElementById('utteranc-comments').appendChild(s);
          }, 100);
        })();
      </script>
      

      

    
  </div>
  
</article>
</main>
<footer class="footer">
  <span>2020 &copy; Make love, not war</span>
  
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"
        integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/routeros.min.js"
        integrity="sha256-OKUUrep5sRJC/VrDnr9rTdY7XR5M/KJ+VfoWqf8Hsic="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"
        integrity="sha256-tvm0lHsuUZcOfj/0C9xJTU4OQx5KpUgxUcAXLX5kvwA="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"
        integrity="sha256-2axosoqkcFJ3cXezszojJ8/PdK8VCYVPOwNq7ersKfk="
        crossorigin="anonymous"
        data-no-instant></script>
<script data-no-instant>
  (function () {

    if (typeof hljs === 'object') {
      hljs.initHighlightingOnLoad();
    }

    let
      $toggle = document.querySelector('.menu-toggle'),
      $body = document.querySelector('body'),
      $outdated = document.querySelectorAll('.outdated-post');

    $toggle.addEventListener('click', function () {
      $body.classList.toggle('noscroll');
    }, false);

    for (var i = 0, len = $outdated.length; i < len; i++) {
      let
        $el = $outdated[i],
        now = new Date(),
        posted_at = new Date($el.getAttribute('data-posted-at')),
        diff = Math.abs(now.getTime() - posted_at.getTime()),
        days = Math.ceil(diff / (1000 * 3600 * 24));

      if (days >= 547  ) {
        $el.style.display = 'block';
        $el.style.visibility = 'visible'
      }
    }

  })();
</script>
</body>
</html>

