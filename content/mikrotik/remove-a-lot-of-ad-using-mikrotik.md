---
title: Чистим интернет от назойливой рекламы (AD Blocker для MikroTik)
date: 2015-08-04T05:19:04+00:00
aliases:
  - /mikrotik/remove-a-lot-of-ad-using-mikrotik.html
featured_image: /images/posts/mikrotik-adaway-wide.jpg
tags:
  - ad
  - habr
  - mikrotik
  - php
  - routeros
---

> Данная статья является копией <a href="https://habr.com/post/264001/" target="_blank">публикации на хабре</a> (написанной мной же).

Данная статья является логическим завершением [небольшой дискуссии][1] с тов. [vvzvlad][2], которая развернулась под топиком "[Чистим домашний интернет от очень назойливой рекламы][3]", где автор с помощью **wget**, **sed** и **cron** на **OpenWRT** успешно сливает файлы рекламных хостов, парсит и подсовывает dns-серверу **dnsmasq**.

<!--more-->

Переадресовывая клиента при запросе "рекламного" домена, например, на loopback (_127.0.0.1 - 127.255.255.255_), вместо котента рекламы клиент получит благодатное "ничего" (_разумеется, при условии, что у нас не работает локальный веб-сервер который слушает локалхост_). Механизм фильтрации довольно старый и не лишен недостатков. Например, нельзя указать маски хостов (*.ad-domain.tld) или "вырезать" рекламу, баннеры которой хостятся на запрашиваемых ресурсах. Но зато не привязан к какому-то либо протоколу и довольно прост в эксплуатации. Более того, если его использовать, например, на домашнем или офисном маршрутизаторе, который используется в качестве DNS сервера, реклама успешно порежется на всех гаджетах, где IP нашей железки прописан первым в качестве DNS сервера.

Но что если у нас вместо роутера с кастомной прошивкой используется.. **MikroTik** (_RouterOS_), функционал которого накладывает некоторые ограничения? Под катом вы узнаете каким образом удалось успешно "**сконвертировать**" файл хостов в пригодный для него формат, как **автоматизировать** это дело и что для хабралюдей в качестве **бонуса** был создан небольшой сервис как раз для автоматизации этого процесса (_маленький, абсолютно бесплатный и с открытыми исходниками_).

### Настраиваем MikroTik

Настройка самой железки вряд ли вызовет какие-либо трудности. Укажем IP маршрутизатора в качестве первого DNS сервера в DHCP - "IP" &rarr; "DHCP Server" &rarr; "Networks" &rarr; %default config%. Первым прописываем IP самого MikroTik-а, нажимаем "OK":

![](https://hsto.org/files/fd9/55d/3d7/fd955d3d7716475ea087718901041939.png)

DNS сервер работает "из коробки", и можно даже не менять его стоковые настройки:

![](https://hsto.org/files/7e4/702/d34/7e4702d34fa44d1899eb7d6e1be04a63.png)
  
Единственная интересная для нас кнопка - "Static" ("Статические маршруты"), в которых мы должны прописать "рекламные" домены, указав куда такие запросы перенаправлять.

### Конвертируем файл хостов

Файл хостов имеет формат:

```
# Any comments
127.0.0.1 localhost
127.0.0.1 domain-a.tld
127.0.0.1 domain-b.tld
```

Формат скрипта для MikroTik, использующий статические DNS маршруты:

```
# Any comments
/ip dns static
add address=127.0.0.1 name=localhost
add address=127.0.0.1 name=domain-a.tld
add address=127.0.0.1 name=domain-b.tld
```

Для получения актуальных списков первого и преобразования их во второй мы выполним простые команды в шелле на, например, десктопе (_bash_):

1. Скачиваем списки и аккуратно складываем их под именами `./hosts_list.1`, `./hosts_list.2` и т.д.:
```bash
$ src=('http://pgl.yoyo.org/adservers/serverlist.php?hostformat=hosts&showintro=0&mimetype=plaintext' 'https://adaway.org/hosts.txt'); i=0; for file in ${src[*]}; do i=$((i+1)); wget --no-check-certificate -O "./hosts_list.$i" "$file"; done;
```

2. Грепаем всё что начинается на `127.0.0.1`, удаляем комменты, оставляем только имена доменов, убираем дубликаты, убираем пустые строки и оформляем каждый домен в виде команды для импорта:
```bash
$ in="./hosts_list.*" && out="./adblock_dns.rsc" && host='127.0.0.1'; echo "/ip dns static" > $out && grep '127.0.0.1 ' $in | grep -v '^#' | cut -d' ' -f 2 | sort -u | grep . | sed "s/^/add address=$host name=/" >> $out && rm -f $in; wc -l $out;
```
    
> _Да, надо бы использовать регулярку и вообще всё переделать, но самое главное - я передал тебе свою мысль, дальше дело за тобой_

На выходе у нас получится файл `adblock_dns.rsc`, который не лишним будет дополнительно проверить на корректность содержимого.

### Импортируем в MikroTik

Для того, чтобы импортировать полученный файл, мы цепляемся к маршрутизатору по ftp, заливаем `adblock_dns.rsc`, после чего цепляемся по ssh или открываем терминал, в котором выполняем:

1. Делаем резервную копию (_полученный бэкап лучше сохранить у себя на машине_): 
```
/system backup save
```

2. Если у тебя в таблице **нет** важных маршрутов, то можем грохнуть все имеющиеся записи:
```
/ip dns static remove [/ip dns static find]
```

3. Импортируем загруженный файл: 
```
/import adblock_dns.rsc
```

4. Убираем за собой:
```
/file remove adblock_dns.rsc
```

Теперь можешь (_опционально_) перезагрузить MikroTik, проверить корректность получения адресов DNS серверов по DHCP и попытаться открыть какой-либо ресурс, который ранее был наводнен рекламой - её должно стать ощутимо меньше.

> Эмпирически доказано что при импортировании ~5500 записей Mikrotik hAP lite (650MHz @ RAM 32 Mb) встает почти колом при попытке в GUI открыть таблицу статических маршрутов. Перезагрузка помогает

### Автоматизация

Один из простейших вариантов автоматизации - **скрипт на баше**, который по крону поддерживает в актуальном состоянии `adblock_dns.rsc`, находящийся в открытом доступе по, скажем, ftp. Его основа была уже описана выше, осталось только оформить его по твоему усмотрению (_необходима отдельная машина_).

Ещё один вариант - это использование **MetaRouter** на самом или соседнем MikroTik-е, на котором установлен тот же OpenWRT (_избавляемся от необходимости в отдельной машине; этот вариант не расписан подробно за неимением достойного MikroTik-а под руками_).

Второй скрипт (_на MikroTik_) забирает его (`adblock_dns.rsc`), делает бэкап и, если и файл скачался успешно, и бэкап сохранился успешно, его импортирует, предварительно (_внимание_) грохнув все имеющиеся маршруты:

```
:local hostScriptUrl &#x22;ftp://user:login@ftp_host:21/adblock_dns.rsc&#x22;;

:local scriptName &#x22;adblock_dns.rsc&#x22;;
:local backupFileName &#x22;before_stopad&#x22;;
:local logPrefix &#x22;[StopAD]&#x22;;

do {
 /tool fetch mode=ftp url=$hostScriptUrl dst-path=(&#x22;./&#x22;.$scriptName);
 :if ([:len [/file find name=$scriptName]] &#x3E; 0) do={
   /system backup save name=$backupFileName;
   :delay 1s;
   :if ([:len [/file find name=($backupFileName.&#x22;.backup&#x22;)]] &#x3E; 0) do={
     /ip dns static remove [/ip dns static find];
     /import file-name=$scriptName;
     /file remove $scriptName;
     :log info &#x22;$logPrefix AD block script imported, backup file (\&#x22;$backupFileName.backup\&#x22;) created&#x22;;
   } else={
     :log warning &#x22;$logPrefix Backup file not created, importing AD block script stopped&#x22;;
   }
 } else={
   :log warning &#x22;$logPrefix Backup file not downloaded, script stopped&#x22;;
 }
} on-error={
 :log warning &#x22;$logPrefix AD block script download FAILED&#x22;;
};
```

### Бонус для хабралюдей

А что делать, если у тебя дома/офисе/гараже стоит MikroTik и хочется или просто порезать рекламу, или автоматизировать обновление хостов, не поднимая никакие метароутеры и хосты с файлами по ftp, вот чтоб просто и без заморочек?
  
Правильно, нужно чтобы это поднял кто то за тебя. И в качестве бонуса - такая штука уже поднята.

Смысл заключается в следующем - тебе достаточно перейти на нужную страницу, указать свои настройки и получить URL, по которому будет доступен скрипт с указанными тобой настройками. Там же будет предоставлен и исходник готового скрипта для тебя. Возможности, которые реализованы на данный момент:

- Выбор из списка публичных файлов-хостов (_спасибо AdAway для Android_);
- Хочется указать свои источники? Без проблем! (_можно, например, указать три публичных хост-файла и два своих, расположенных на том-же [gist.github.com](https://gist.github.com/), получив таким образом довольное удобное средство управления статическими маршрутами на подопечных маршрутизаторах_);
- Настраиваемый адрес (_IP v4_) перенаправления;
- Указание ограничения (_лимита_) количества записей в итоговом скрипте (_для того чтоб "случайно" не положить "слабую" железку_);
- Указание своих маршрутов (_будут просто добавлены первыми в генерируемый скрипт_);
- Возможность указания исключений - нужные домены никогда не будут "заблокированы";
- Довольно удобная генерация готового скрипта для MikroTik;

Парсер написан на PHP (_потребует php5-curl_), лицензия [MIT][5], исходники доступны по ссылке [mikrotik-hosts-parser][6]. Сколько сервис проживет - не берусь загадывать, но надеюсь что достаточно долго. Стойкую к хабраэффекту площадку любезно предоставил тов. @drakmail, за что спасибо ему и команде [Generate.Club][7].

- [stopad.cgood.ru](https://stopad.cgood.ru/)
- [stopad.hook.sh](https://stopad.hook.sh/)

> **ВНИМАНИЕ!** Если вы ранее пользовались скриптом по ссылке выше, и у вас внезапно он перестал работать — знайте, причина в его обновлении. Первым делом попробуйте всё там же просто взять его обновленную редакцию, после этого всё должно успешно заработать. Приношу свои извинения за возможные неудобства!

> Если после перехода на обновленную версию скрипта у вас появляются в логе микротика ошибки, содержащие текст: `script error: failure: entry already exists`, то рекомендую или ручками сперва снести все имеющиеся статические маршруты (оставив необходимые, разумеется), или выполнив в консоли `/ip dns static remove [/ip dns static find];`

> _Диклеймер: 1. Команда Generate.Club не имеет отношения к сервису. 2. Не хорошо допускать кого-либо к исполнению кода на твоих маршрутизаторах. Поэтому призываю пользоваться им исключительно в ознакомительных целях. Если всё нравится, сделай форк, настрой под себя да пользуйся на здоровье. За возможные перебои в работе, хабраэффект или ошибки ответственности никто не несет. 3. Я приложу все усилия, чтобы всё работало "как надо" максимально продолжительное время, но нужно понимать степень ответственности._

> _При обнаружении ошибок в работе сервиса или опечаток в тексте - пожалуйста, сообщайте об этом в личку. Заранее спасибо!_

[1]: https://habr.com/post/263081/#comment_8509571
[2]: https://habr.com/users/vvzvlad/
[3]: https://habr.com/post/263081/
[5]: https://gist.githubusercontent.com/tarampampam/4d4af291ffd4de29c3a9/raw/cb30514aa511f06b2bfa62f765eb97917c3e4481/.txt
[6]: https://github.com/tarampampam/mikrotik-hosts-parser
[7]: http://generate.club/
 