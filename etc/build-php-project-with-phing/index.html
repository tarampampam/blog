<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Автоматическая сборка PHP-проектов с помощью PhiNG - blog [dot] hook</title>
  
  <meta name="description" content="Что я подразумеваю под сборкой? Сборка - это процесс действий, которые выполняются над кодом проекта перед его деплоем. Она может включать в себя создание копии проекта, очистка директории с кэшем, минификация CSS и JS файлов, упаковка результата в один zip-архив. Так же возможно ещё и автоматическое развертывание проекта а удаленном сервере, но сегодня речь об этом идти не будет.">
  <meta name="author" content="Paramtamtam">
  
  <style>
    .pace {pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}
    .pace-inactive {display:none}
    .pace .pace-progress {background:#2299dd;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:1px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"
          integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM="
          crossorigin="anonymous"></script>
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/obsidian.min.css"
        integrity="sha256-DSLpkHOyIkdP+qB1tVfhDqoTis6ZnkH6fJIYxRoMUZY="
        crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
        crossorigin="anonymous" />
  <link href="https://tarampampam.github.io/blog/css/style.css?v=1590235742" rel="stylesheet">
  
  <link rel="apple-touch-icon" sizes="180x180" href="https://tarampampam.github.io/blog/apple-touch-icon.png?v=1590235742">
  <link rel="icon" type="image/png" sizes="32x32" href="https://tarampampam.github.io/blog/favicon-32x32.png?v=1590235742">
  <link rel="icon" type="image/png" sizes="16x16" href="https://tarampampam.github.io/blog/favicon-16x16.png?v=1590235742">
  <link rel="manifest" href="https://tarampampam.github.io/blog/site.webmanifest">
  <meta name="msapplication-TileColor" content="#282b2f">
  <meta name="theme-color" content="#282b2f">
  
  </head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://tarampampam.github.io/blog/">blog [dot] hook</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/blog/adm/">Adm</a>
        </li>
        
        <li class="">
          <a href="/blog/dev/">Dev</a>
        </li>
        
        <li class="">
          <a href="/blog/docker/">Docker</a>
        </li>
        
        <li class="">
          <a href="/blog/etc/">Etc</a>
        </li>
        
        <li class="">
          <a href="/blog/hack/">Hack</a>
        </li>
        
        <li class="">
          <a href="/blog/hard/">Hard</a>
        </li>
        
        <li class="">
          <a href="/blog/mikrotik/">Mikrotik</a>
        </li>
        
        <li class="">
          <a href="/blog/my-book-live/">My-book-live</a>
        </li>
        
        <li class="">
          <a href="/blog/nix/">Nix</a>
        </li>
        
        <li class="">
          <a href="/blog/php/">Php</a>
        </li>
        
        <li class="">
          <a href="/blog/software/">Software</a>
        </li>
        
        <li class="">
          <a href="/blog/text/">Text</a>
        </li>
        
        <li class="">
          <a href="/blog/tnt/">Tnt</a>
        </li>
        
        <li class="">
          <a href="/blog/wp/">Wp</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="headline">Автоматическая сборка PHP-проектов с помощью PhiNG</h1>
    <p class="post-meta"><i class="fa fa-user-secret" aria-hidden="true"></i> <span itemprop="author">
        Paramtamtam
      </span> · 
      <i class="fa fa-calendar-check-o" aria-hidden="true"></i>&nbsp;<time datetime="2016-02-16"
        itemprop="datePublished">2016.2.16</time>
      &nbsp;&middot; <i class="fa fa-clock-o" aria-hidden="true"></i> 5 min
    </p>
  </header>
  <div class="post-content" itemprop="articleBody">
    
      <div class="post-featured-image">
        <img src="https://tarampampam.github.io/blog//images/posts/phing-wide.jpg" itemprop="image" alt="Автоматическая сборка PHP-проектов с помощью PhiNG" />
      </div>
    

    <div class="outdated-post" data-posted-at="2016-02-16">
      <strong>Внимание!</strong> Данный пост был опубликован более года назад и, возможно, уже утратил свою былую
      актуальность. Но это не точно.
    </div>

    <p>Что я подразумеваю под сборкой? Сборка - это процесс действий, которые выполняются над кодом проекта перед его деплоем. Она может включать в себя создание копии проекта, очистка директории с кэшем, минификация CSS и JS файлов, упаковка результата в один zip-архив. Так же возможно ещё и автоматическое развертывание проекта а удаленном сервере, но сегодня речь об этом идти не будет.</p>

<p>Другими словами - это автоматизация однотипных и рутинных действий. А там где есть однотипные действия - там место автоматизации :) Сегодня мы рассмотрим на живом примере один из способов с применением PhiNG, причем всё будем делать с самого начала - скачаем исходники, интерпритатор (<em>в нашем случае это PHP</em>), и всё это дело настроим.</p>

<h3 id="подготовка">Подготовка</h3>

<p>Итак, мы работаем под Windows. Первым делом определимся с тем, как у нас всё располагается. Имеется директория <code>%project_name%</code>, в которой лежит директория <code>sources</code> с исходниками проекта (<em>пролинкована как домашняя директория на тестовом веб-сервере</em>), там же лежит <code>README.md</code> файл, и всё это располагается в Git-е (<em>всё всегда храним в Git-е</em>). Визуально это выглядит так:</p>

<pre><code>[dir] %project_name%
  |- [dir] .git
  |- [dir] sources (исходники проекта)
  |- [file] .gitignore
  \- [file] README.md
</code></pre>

<p>В итоге нам необходимо чтоб была создана копия директории <code>sources</code>; над ней были произведены действия в виде минификации JS и CSS файлов, из PHP-файлов были удалены все комментарии; и в результате она упаковалась в файл <code>build_%timestamp%.zip</code>, удалив старую копию.</p>

<h3 id="ставим-phing">Ставим PhiNG</h3>

<p>В директории с проектом создадим ещё одну директорию, назвав её <code>build_tools</code>, в которую качаем <a href="https://github.com/phingofficial/phing/archive/master.zip">крайнюю версию PhiNG</a> (<a href="https://github.com/phingofficial/phing">GitHub</a>. Распаковываем из архива содержимое директории <code>phing-master</code> в директорию <code>.\build_tools\phing\</code>, после удалив всё, кроме директорий <code>bin</code>, <code>classes</code> и <code>etc</code>. Из директории <code>bin</code> копируем <code>phing.bat</code> в корневую директорию проекта, и называем его <code>build.cmd</code>.</p>

<h3 id="ставим-php">Ставим PHP</h3>

<p>Теперь нам потребуется сам PHP. Берем его с <a href="http://windows.php.net/download/">официального сайта</a>, выбираем версию <code>5.5</code> под Windows. Распаковываем содержимое архива в директорию <code>.\build_tools\php-5\</code>, и удаляем всё, кроме файлов <code>php.exe</code>, <code>php.ini</code> и <code>php5.dll</code>. Всё что нам понадобится уже вкомпилено в сборку. В файле <code>php.ini</code> добавляем дефолтовую таймзону - сразу же после строки <code>[Date]</code> добавляем строку, например <code>date.timezone = &quot;Asia/Yekaterinburg&quot;</code>. Особого значения какая именно таймзона стоит - нет, но важно чтоб она была указана (<em>иначе PhiNG будет выдавать херову кучу warning-ов</em>). На этом считаем что PHP у нас готов.</p>

<h3 id="переходим-к-настройке">Переходим к настройке</h3>

<p>В файле <code>build.cmd</code> (<em>что уже лежит в корне проекта</em>) необходимо указать где у нас располагается интерпритатор и PhiNG. Для этого редатируем две строки:</p>

<pre><code>...
set DEFAULT_PHING_HOME=&quot;.\build_tools\phing&quot;
...
set PHP_COMMAND=&quot;.\build_tools\php-5\php.exe&quot;
...
</code></pre>

<p>Больше тут делать ничего нам более не придется. Остается создать файл конфигурации сборки - с корне проекта создадим файл <code>build.xml</code>, со следующим содержимым:</p>

<blockquote>
<p><strong>Важный момент!</strong> Для минификации JS и CSS файлов я использую <a href="https://github.com/matthiasmullie/minify">Minify</a>, который пришлось &ldquo;прикручивать&rdquo; отдельно, так как в дефолтовой комплектации он просто не идет. Рассказ о том как его &ldquo;прикручивал&rdquo; достоин отдельного поста, но сейчас об этом речи не идет. Поэтому в конце статьи будут ссылки на уже готовую сборку PhiNG вместе с PHP в одном флаконе, с файлом конфигурации и запуском сборки.</p>
</blockquote>

<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!-- On-line help: &lt;https://www.phing.info/docs/guide/stable/&gt; --&gt;
&lt;project name=&quot;project_name&quot; basedir=&quot;sources/&quot; default=&quot;build&quot;&gt;
  &lt;property name=&quot;build_dir&quot; value=&quot;../build/&quot; override=&quot;false&quot; /&gt;

  &lt;tstamp&gt;
    &lt;format pattern=&quot;%Y_%m_%d__%H-%M-%S&quot; property=&quot;build.time&quot; /&gt;  
  &lt;/tstamp&gt;
  
  &lt;target name=&quot;make_copy&quot;&gt;
    &lt;if&gt;
      &lt;available file=&quot;${build_dir}&quot; type=&quot;dir&quot; /&gt;
      &lt;then&gt;
        &lt;echo&gt;Remove old build directory&lt;/echo&gt;
        &lt;delete dir=&quot;${build_dir}&quot; includeemptydirs=&quot;true&quot; verbose=&quot;false&quot; failonerror=&quot;true&quot; /&gt;
      &lt;/then&gt;
    &lt;/if&gt;
    &lt;echo&gt;Make project copy&lt;/echo&gt;
    &lt;copy todir=&quot;${build_dir}&quot; includeemptydirs=&quot;true&quot; verbose=&quot;false&quot; &gt;
      &lt;fileset dir=&quot;.&quot;&gt;
        &lt;include name=&quot;**/**&quot; /&gt;
      &lt;/fileset&gt;
    &lt;/copy&gt;
  &lt;/target&gt;
  
  &lt;target name=&quot;make_clean&quot; depends=&quot;make_copy&quot;&gt;
    &lt;echo&gt;Clear cache&lt;/echo&gt;
    &lt;delete&gt;
      &lt;fileset dir=&quot;${build_dir}/cache/&quot;&gt;
        &lt;exclude name=&quot;.htaccess&quot; /&gt;
      &lt;/fileset&gt;
    &lt;/delete&gt;
    &lt;echo&gt;Clear database directory&lt;/echo&gt;
    &lt;delete&gt;
      &lt;fileset dir=&quot;${build_dir}/db/&quot;&gt;
        &lt;exclude name=&quot;.htaccess&quot; /&gt;
      &lt;/fileset&gt;
    &lt;/delete&gt;
    &lt;echo&gt;Clear logs directory&lt;/echo&gt;
    &lt;delete&gt;
      &lt;fileset dir=&quot;${build_dir}/log/&quot;&gt;
        &lt;exclude name=&quot;.htaccess&quot; /&gt;
      &lt;/fileset&gt;
    &lt;/delete&gt;
  &lt;/target&gt;
  
  &lt;target name=&quot;min_js&quot; depends=&quot;make_copy&quot;&gt;
    &lt;taskdef name=&quot;jsminify&quot; classname=&quot;phing.tasks.JsMinifyTask&quot; /&gt;
    &lt;echo&gt;Minifying JavaScript files&lt;/echo&gt;
    &lt;jsminify targetdir=&quot;${build_dir}&quot; failOnError=&quot;true&quot;&gt;
      &lt;fileset dir=&quot;${build_dir}&quot;&gt;
        &lt;include name=&quot;**/*.js&quot; /&gt;
        &lt;exclude name=&quot;**/*.min.js&quot; /&gt;
      &lt;/fileset&gt;
    &lt;/jsminify&gt;
  &lt;/target&gt;
  
  &lt;target name=&quot;min_css&quot; depends=&quot;make_copy&quot;&gt;
    &lt;taskdef name=&quot;cssminify&quot; classname=&quot;phing.tasks.CssMinifyTask&quot; /&gt;
    &lt;echo&gt;Minifying CSS files&lt;/echo&gt;
    &lt;cssminify targetdir=&quot;${build_dir}&quot; failOnError=&quot;true&quot;&gt;
      &lt;fileset dir=&quot;${build_dir}&quot;&gt;
        &lt;include name=&quot;**/*.css&quot; /&gt;
        &lt;exclude name=&quot;**/*.min.css&quot; /&gt;
      &lt;/fileset&gt;
    &lt;/cssminify&gt;
  &lt;/target&gt;
  
  &lt;target name=&quot;protect_php&quot; depends=&quot;make_copy&quot;&gt;
    &lt;echo&gt;Protect PHP files&lt;/echo&gt;
    &lt;reflexive&gt;
      &lt;fileset dir=&quot;${build_dir}&quot;&gt;
        &lt;include name=&quot;**/*.php&quot; /&gt;
      &lt;/fileset&gt;
      &lt;filterchain&gt;
        &lt;stripwhitespace /&gt;
        &lt;tabtospaces tablength=&quot;1&quot; /&gt;
      &lt;/filterchain&gt;
    &lt;/reflexive&gt;
  &lt;/target&gt;
  
  &lt;target name=&quot;pack&quot; depends=&quot;make_copy&quot;&gt;
    &lt;echo&gt;Pack to single archive&lt;/echo&gt;
    &lt;zip destfile=&quot;../build_${build.time}.zip&quot;&gt;
      &lt;fileset dir=&quot;${build_dir}&quot;&gt;
        &lt;include name=&quot;**/**&quot; /&gt;
      &lt;/fileset&gt;
    &lt;/zip&gt;
  &lt;/target&gt;
  
  &lt;target name=&quot;remove_copy&quot; depends=&quot;make_copy&quot;&gt;
    &lt;echo&gt;Remove build directory&lt;/echo&gt;
    &lt;delete dir=&quot;${build_dir}&quot; includeemptydirs=&quot;true&quot; verbose=&quot;false&quot; failonerror=&quot;false&quot; /&gt;
  &lt;/target&gt;

  &lt;target name=&quot;build&quot; depends=&quot;make_copy,make_clean,protect_php,min_js,min_css,pack,remove_copy&quot;&gt;
    &lt;echo&gt;Build complete&lt;/echo&gt;
  &lt;/target&gt;
&lt;/project&gt;
</code></pre>

<p>Чуть-чуть поясню конфигурацию:</p>

<ul>
<li>Первым делом мы объявляем имя проекта и указываем директорию где хранятся его исходники, так же указав дефолтовую цель: <code>build</code>. <code>&lt;project name=&quot;project_name&quot; basedir=&quot;sources/&quot; default=&quot;build&quot;&gt;</code></li>
<li>После мы добавили новое свойство <code>build_dir</code> со значением <code>../build/</code>, указав таким образом где у нас будет располагаться директория с билдом. Более того, к этому значению из конфига можно будет обращаться по <code>${build_dir}</code>. <code>&lt;property name=&quot;build_dir&quot; value=&quot;../build/&quot; override=&quot;false&quot; /&gt;</code></li>
<li>Секция с таймстампом мне кажется и так понятна - просто указываем формат временной метки, и после при необходимости к ней обращаемся по <code>${build.time}</code></li>
<li>Далее идут описания с &ldquo;целями&rdquo; (<em>читай в данном контекте - действиями</em>), тут всё должно быть более и менее понятно. В любой непонятной ситуации <a href="https://www.phing.info/docs/guide/stable/">читай документацию</a></li>
<li>В конце мы указываем самую главную цель <code>build</code> (<em>указанную в самом начале</em>), в зависимостях которой перечисляем те, от которых она зависит (<em>читай - те действия, которые необходимо выполнить</em>)</li>
</ul>

<p>Пояснять каждую цель не вижу особого смысла, т.к. <a href="https://www.phing.info/docs/guide/stable/">есть документация</a>, да и вообще они вполне интуитивны. Если будут какие-либо вопросы - спрашивай смело в комментариях - постараюсь на них ответить.</p>

<p>И остается самый ответственный момент - запустить сборку. Выполняем файл <code>build.cmd</code>:</p>

<p><img src="https://hsto.org/webt/vl/pl/cf/vlplcfrqqvzp166enxyrmiftk74.png" alt="screen shot" /></p>

<p>Как видим - сборка прошла без ошибок, и у нас в директории с проектом появился файл <code>build_%timestamp%.zip</code>, в котором все ресурсы нежно упакованы :) Как ты уже догадываешься - возможностей у PhiNG дохрена и больше - можно как делать и автоматическую загрузку итогового архива на удаленный сервер, так и производить массу иных операций. Но сейчас мы просто ознакомились с общим функционалом.</p>

    
    </blockquote>
  </div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="https://tarampampam.github.io/blog/tags/build/">build</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/phing/">phing</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/php/">php</a></li>
      
      <li><a href="https://tarampampam.github.io/blog/tags/windows/">windows</a></li>
      
    </ul>
    
  </footer>
  

  
    <div class="comments-area">
      
      <div id="utteranc-comments"></div>
      <script>
        (function () {
          window.setTimeout(function () {
            let d = document, s = d.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'tarampampam\/blog');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('theme', 'photon-dark');
            s.async = true;
            s.defer = true;
            d.getElementById('utteranc-comments').appendChild(s);
          }, 100);
        })();
      </script>
      

      

    
  </div>
  
</article>
</main>
<footer class="footer">
  <span>2020 &copy; Make love, not war</span>
  
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"
        integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"
        integrity="sha256-tvm0lHsuUZcOfj/0C9xJTU4OQx5KpUgxUcAXLX5kvwA="
        crossorigin="anonymous"
        data-no-instant></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"
        integrity="sha256-2axosoqkcFJ3cXezszojJ8/PdK8VCYVPOwNq7ersKfk="
        crossorigin="anonymous"
        data-no-instant></script>
<script data-no-instant>
  (function () {

    if (typeof hljs === 'object') {
      hljs.initHighlightingOnLoad();
    }

    let
      $toggle = document.querySelector('.menu-toggle'),
      $body = document.querySelector('body'),
      $outdated = document.querySelectorAll('.outdated-post');

    $toggle.addEventListener('click', function () {
      $body.classList.toggle('noscroll');
    }, false);

    for (var i = 0, len = $outdated.length; i < len; i++) {
      let
        $el = $outdated[i],
        now = new Date(),
        posted_at = new Date($el.getAttribute('data-posted-at')),
        diff = Math.abs(now.getTime() - posted_at.getTime()),
        days = Math.ceil(diff / (1000 * 3600 * 24));

      if (days >= 547  ) {
        $el.style.display = 'block';
        $el.style.visibility = 'visible'
      }
    }

  })();
</script>
</body>
</html>

